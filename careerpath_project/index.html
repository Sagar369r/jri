<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JRI Career World - Minecraft Edition</title>
    <link rel="icon" href="https://static.wikia.nocookie.net/minecraft_gamepedia/images/7/7d/Bee.png/revision/latest?cb=20200502032Bee.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Pixelify+Sans:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --mc-stone: #787878; --mc-stone-dark: #505050; --mc-stone-light: #C6C6C6;
            --mc-dirt: #976B4B; --mc-wood: #89634A; --mc-wood-dark: #5E4633;
            --mc-green: #55FF55; --mc-red: #FF5555; --mc-blue: #5555FF;
            --mc-diamond: #55FFFF; --mc-gold: #FFFF55; --mc-iron: #C6C6C6;
        }
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #373737;
            /* FIXED: Using a reliable texture link */
            background-image: url('https://www.minecraft.net/etc.clientlibs/minecraft/clientlibs/main/resources/img/bg-texture-stone.png'); 
            color: #ffffff;
        }
        h1, h2, h3, h4, .btn-pixel { font-family: 'Pixelify Sans', 'sans-serif'; }
        .mc-ui {
            background-color: var(--mc-stone-light);
            border: 4px solid var(--mc-stone-dark);
            border-top-color: #FFFFFF;
            border-left-color: #FFFFFF;
            box-shadow: 0 0 0 4px var(--mc-stone);
            color: #373737;
            image-rendering: pixelated;
        }
        .btn-pixel { 
            background: var(--mc-stone-light);
            border-width: 4px; border-style: solid; border-color: #FFFFFF var(--mc-stone-dark) var(--mc-stone-dark) #FFFFFF;
            padding: 0.75rem 1.5rem; color: #373737; font-weight: 700; text-align: center; cursor: pointer;
            text-shadow: 2px 2px #5050504a; display: inline-flex; align-items: center; justify-content: center;
        }
        .btn-pixel:hover:not(:disabled) { filter: brightness(1.1); }
        .btn-pixel:active:not(:disabled) { border-color: var(--mc-stone-dark) #FFFFFF #FFFFFF var(--mc-stone-dark); }
        .btn-pixel:disabled { background: var(--mc-stone); color: var(--mc-stone-dark); cursor: not-allowed; }

        .hidden { display: none; }
        .icon-pixel { width: 32px; height: 32px; image-rendering: pixelated; }

        /* Custom Scrollbar for thematic feel */
        ::-webkit-scrollbar { width: 16px; }
        ::-webkit-scrollbar-track { background: var(--mc-stone-dark); }
        ::-webkit-scrollbar-thumb { background: var(--mc-stone-light); border: 4px solid var(--mc-stone-dark); }
    </style>
</head>
<body class="text-lg">

    <div id="main-content" class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <div id="login-section" class="mc-ui p-8 max-w-lg mx-auto flex flex-col items-center">
            <!-- FIXED: Using a reliable image link -->
            <img src="https://media.tenor.com/mc3yG9kF51AAAAAi/bee-minecraft.gif" alt="Minecraft Bee" class="w-24 h-24 mb-4">
            <h2 class="text-3xl font-bold mb-2">Welcome to JRI Career World</h2>
            <p class="mb-6 text-center">Enter your email to join the world.</p>
            <form id="magic-link-form" class="w-full">
                <input type="email" id="email-input" placeholder="player@email.com" required class="w-full mb-4 mc-ui !border-stone-dark !p-3 !text-lg !font-['Pixelify_Sans']">
                <button type="submit" class="btn-pixel w-full">Request Magic Link</button>
            </form>
            <p id="auth-message" class="mt-4 font-bold h-6"></p>
        </div>

        <div id="dashboard-section" class="hidden">
            <div class="mc-ui p-4 mb-8 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <!-- FIXED: Using a reliable image link -->
                    <img src="https://www.minecraft.net/content/dam/games/minecraft/avatars/Character-Creator-Steve-Avatar.png" alt="Player" class="w-16 h-16">
                    <div>
                        <p class="text-sm text-gray-600">Player:</p>
                        <p id="user-email" class="font-bold text-xl"></p>
                    </div>
                </div>
                <button id="logout-btn" class="btn-pixel">Quit World</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-3 space-y-8">
                    <div id="assessment-area" class="mc-ui p-6">
                        <h2 class="text-3xl font-bold mb-4 flex items-center gap-3">
                            <!-- FIXED: Using a reliable image link -->
                            <img src="https://static.wikia.nocookie.net/minecraft_gamepedia/images/4/44/Map_JE3_BE2.png" class="icon-pixel" alt="Quest Icon">Quest Board
                        </h2>
                        <button id="start-assessment-btn" class="btn-pixel w-full text-xl">Accept New Quest</button>
                        <div id="questions-container" class="mt-6 hidden space-y-6"></div>
                        <button id="submit-assessment-btn" class="btn-pixel w-full mt-6 hidden">Complete Quest</button>
                    </div>
                    <div id="results-area" class="mc-ui p-6 hidden">
                         <h2 class="text-3xl font-bold mb-4 flex items-center gap-3">
                           <!-- FIXED: Using a reliable image link -->
                           <img src="https://static.wikia.nocookie.net/minecraft_gamepedia/images/a/a4/Librarian_JE4.png" class="icon-pixel" alt="Librarian Icon">Librarian's Wisdom
                        </h2>
                        <div class="flex gap-4">
                             <!-- FIXED: Using a reliable image link -->
                            <img src="https://static.wikia.nocookie.net/minecraft_gamepedia/images/a/a4/Librarian_JE4.png" alt="Librarian" class="w-24 h-24 hidden sm:block">
                            <div id="ai-analysis" class="prose max-w-none prose-p:my-2 prose-headings:font-['Pixelify_Sans'] prose-headings:text-stone-800"></div>
                        </div>
                    </div>
                     <div id="courses-area" class="mc-ui p-6 hidden">
                        <h2 class="text-3xl font-bold mb-4">Enchanted Books (Course Suggestions)</h2>
                        <div id="course-suggestions-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                    </div>
                </div>

                <div class="lg:col-span-2 space-y-8">
                    <div id="resume-analyzer-area" class="mc-ui p-6">
                        <h2 class="text-3xl font-bold mb-4 flex items-center gap-3">
                           <!-- FIXED: Using a reliable image link -->
                           <img src="https://static.wikia.nocookie.net/minecraft_gamepedia/images/4/4b/Crafting_Table_JE4_BE3.png" class="icon-pixel" alt="Crafting Table Icon">Crafting Table
                        </h2>
                        <p class="mb-4 text-sm">Place your Resume Scroll on the table to reveal its enchantments.</p>
                        <input type="file" id="resume-file-input" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:btn-pixel" accept=".pdf,.docx">
                        <button id="analyze-resume-btn" class="btn-pixel w-full mt-4">Analyze Scroll</button>
                        <div id="resume-analysis-container" class="mt-4 pt-4 border-t-4 border-stone-500 hidden">
                             </div>
                    </div>
                     <div id="performance-dashboard-area" class="mc-ui p-6">
                        <h2 class="text-3xl font-bold mb-4 flex items-center gap-3">
                           <!-- FIXED: Using a reliable image link -->
                           <img src="https://static.wikia.nocookie.net/minecraft_gamepedia/images/5/54/Minecart_JE2_BE2.png" class="icon-pixel" alt="Minecart Icon">The Depths (Stats)
                        </h2>
                        <!-- FIXED: Using a reliable image link -->
                        <div id="performance-chart-container" class="mt-4" style="background-image: url('https://static.wikia.nocookie.net/minecraft_gamepedia/images/1/1b/Powered_Rail_JE2_BE2.png'); background-repeat: repeat-x; background-position: bottom; padding-bottom: 20px;">
                            <canvas id="score-chart"></canvas>
                        </div>
                         <div class="mt-4 grid grid-cols-2 gap-4 text-center">
                            <div class="bg-gray-300 p-2 border-2 border-stone-500"><p class="text-gray-600">High Score</p><p id="highest-score" class="text-3xl font-bold flex items-center justify-center gap-1"></p></div>
                            <div class="bg-gray-300 p-2 border-2 border-stone-500"><p class="text-gray-600">Avg Score</p><p id="average-score" class="text-3xl font-bold"></p></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script>
        // --- CONFIGURATION ---
        const API_BASE_URL = "";
        let apiToken = null;
        let scoreChart = null;

        // --- DOM ELEMENT CACHE ---
        const loginSection = document.getElementById('login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const userEmailEl = document.getElementById('user-email');
        const startAssessmentBtn = document.getElementById('start-assessment-btn');
        const questionsContainer = document.getElementById('questions-container');
        const submitAssessmentBtn = document.getElementById('submit-assessment-btn');
        const resultsArea = document.getElementById('results-area');
        const aiAnalysisEl = document.getElementById('ai-analysis');
        const authMessageEl = document.getElementById('auth-message');
        const logoutBtn = document.getElementById('logout-btn');
        const magicLinkForm = document.getElementById('magic-link-form');
        const emailInput = document.getElementById('email-input');
        const performanceChartContainer = document.getElementById('performance-chart-container');
        const highestScoreEl = document.getElementById('highest-score');
        const averageScoreEl = document.getElementById('average-score');
        const coursesArea = document.getElementById('courses-area');
        const courseSuggestionsContainer = document.getElementById('course-suggestions-container');
        const resumeFileInput = document.getElementById('resume-file-input');
        const analyzeResumeBtn = document.getElementById('analyze-resume-btn');
        const resumeAnalysisContainer = document.getElementById('resume-analysis-container');
        
        // --- UTILITY ---
        async function apiFetch(endpoint, options = {}) {
            const headers = { ...options.headers };
            if (apiToken) headers['Authorization'] = `Bearer ${apiToken}`;

            const response = await fetch(`${API_BASE_URL}/api${endpoint}`, { ...options, headers });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ detail: `Request failed with status ${response.status}` }));
                throw new Error(errorData.detail);
            }
            if (response.status === 204 || response.status === 202) return null;
            return response.json();
        }

        // --- AUTHENTICATION ---
        magicLinkForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value;
            authMessageEl.textContent = 'Sending link...';
            try {
                await apiFetch('/auth/magic-link/request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                authMessageEl.textContent = 'Magic link sent! Check your email.';
            } catch (error) {
                authMessageEl.textContent = error.message;
            }
        });

        async function loginWithToken(token) {
            authMessageEl.textContent = 'Verifying magic link...';
            try {
                const data = await apiFetch('/auth/magic-link/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                apiToken = data.access_token;
                localStorage.setItem('jri_api_token', apiToken); // Persist token
                window.history.replaceState({}, document.title, "/");
                await initializeDashboard();
            } catch (error) {
                authMessageEl.textContent = `Login failed: ${error.message}`;
            }
        }
        
        logoutBtn.addEventListener('click', () => {
            apiToken = null;
            localStorage.removeItem('jri_api_token');
            dashboardSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
        });

        // --- INITIALIZATION ---
        async function initializeDashboard() {
            loginSection.classList.add('hidden');
            dashboardSection.classList.remove('hidden');
            
            const user = await apiFetch('/users/me');
            userEmailEl.textContent = user.email;

            if (user.resume_analysis) {
                 renderResumeAnalysis(user.resume_analysis);
            }
            fetchHistoryAndRenderDashboard();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const magicToken = urlParams.get('token');
            const storedToken = localStorage.getItem('jri_api_token');

            if (magicToken) loginWithToken(magicToken);
            else if (storedToken) {
                apiToken = storedToken;
                initializeDashboard();
            }
        });

        // --- QUEST / ASSESSMENT LOGIC ---
        startAssessmentBtn.addEventListener('click', async () => {
            startAssessmentBtn.textContent = 'Loading...';
            startAssessmentBtn.disabled = true;
            try {
                const questions = await apiFetch('/assessment/questions');
                renderQuestions(questions);
                questionsContainer.classList.remove('hidden');
                submitAssessmentBtn.classList.remove('hidden');
                startAssessmentBtn.classList.add('hidden');
                resultsArea.classList.add('hidden');
                coursesArea.classList.add('hidden');
            } catch (error) { 
                alert(`Error fetching quest: ${error.message}`);
            } finally {
                startAssessmentBtn.textContent = 'Accept New Quest';
                startAssessmentBtn.disabled = false;
            }
        });

        function renderQuestions(questions) {
            questionsContainer.innerHTML = '';
            questions.forEach((q, index) => {
                const questionEl = document.createElement('div');
                questionEl.className = 'p-4 mc-ui !bg-stone-200';
                questionEl.dataset.questionId = q.id;
                questionEl.innerHTML = `<p class="font-bold mb-3 text-xl">${index + 1}. ${q.text}</p>`;
                
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'space-y-2';

                const validOptions = q.options.filter(opt => opt && opt.text && opt.text.trim().toLowerCase() !== 'nan');

                if (validOptions.length > 1) { // Multiple choice
                    validOptions.forEach(opt => {
                        optionsContainer.innerHTML += `<label class="flex items-center p-2 hover:bg-stone-300 cursor-pointer text-lg"><input type="radio" name="question-${q.id}" value="${opt.id}" class="mr-3 w-5 h-5 accent-stone-600"><span>${opt.text}</span></label>`;
                    });
                } else if (validOptions.length === 1) { // Text input
                    const opt = validOptions[0];
                    optionsContainer.innerHTML = `<input type="text" placeholder="Type your answer..." class="w-full p-2 mc-ui !border-stone-500 !text-lg" data-option-id="${opt.id}">`;
                }
                questionEl.appendChild(optionsContainer);
                questionsContainer.appendChild(questionEl);
            });
        }

        submitAssessmentBtn.addEventListener('click', async () => {
            const answers = [];
            document.querySelectorAll('[data-question-id]').forEach(qEl => {
                const questionId = parseInt(qEl.dataset.questionId);
                const radio = qEl.querySelector('input[type="radio"]:checked');
                const textInput = qEl.querySelector('input[type="text"]');

                if (radio) {
                    answers.push({ question_id: questionId, selected_option_id: parseInt(radio.value) });
                } else if (textInput && textInput.value.trim() !== '') {
                    answers.push({
                        question_id: questionId,
                        selected_option_id: parseInt(textInput.dataset.optionId),
                        answer_text: textInput.value.trim()
                    });
                }
            });

            if (answers.length === 0) {
                alert('Please answer at least one question.');
                return;
            }

            submitAssessmentBtn.textContent = 'Submitting...';
            submitAssessmentBtn.disabled = true;
            try {
                const result = await apiFetch('/assessment/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answers })
                });
                displayResults(result);
                fetchHistoryAndRenderDashboard(); // Refresh stats
                questionsContainer.classList.add('hidden');
                submitAssessmentBtn.classList.add('hidden');
                startAssessmentBtn.classList.remove('hidden');
            } catch (error) { 
                alert(`Error submitting quest: ${error.message}`);
            } finally {
                submitAssessmentBtn.textContent = 'Complete Quest';
                submitAssessmentBtn.disabled = false;
            }
        });

        function displayResults(result) {
            resultsArea.classList.remove('hidden');
            aiAnalysisEl.innerHTML = marked.parse(result.analysis || "The librarian has no wisdom to share at this time.");
            
            try {
                const suggestions = JSON.parse(result.suggestions || '[]');
                renderCourseSuggestions(suggestions);
            } catch (e) {
                console.error("Could not parse course suggestions:", e);
                coursesArea.classList.add('hidden');
            }
        }
        
        function renderCourseSuggestions(suggestions) {
            if (!suggestions || suggestions.length === 0) {
                coursesArea.classList.add('hidden');
                return;
            }
            courseSuggestionsContainer.innerHTML = '';
            suggestions.forEach(course => {
                const card = document.createElement('div');
                card.className = 'flashcard-pixel !flex-row items-center gap-4';
                card.innerHTML = `
                    <!-- FIXED: Using a reliable image link -->
                    <img src="https://static.wikia.nocookie.net/minecraft_gamepedia/images/4/42/Enchanted_Book.gif" alt="Book" class="w-12 h-12">
                    <div>
                        <h4 class="font-bold text-xl">${course.course_name || "Enchanted Tome"}</h4>
                        <p class="text-sm text-gray-600 font-bold">${course.platform || "Unknown"}</p>
                        <p class="text-gray-800 text-base">${course.reason || ""}</p>
                    </div>
                `;
                courseSuggestionsContainer.appendChild(card);
            });
            coursesArea.classList.remove('hidden');
        }

        // --- RESUME ANALYSIS ---
        analyzeResumeBtn.addEventListener('click', async () => {
            const file = resumeFileInput.files[0];
            if (!file) {
                alert('Please select a scroll to analyze.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            analyzeResumeBtn.textContent = 'Analyzing...';
            analyzeResumeBtn.disabled = true;

            try {
                const result = await apiFetch('/users/me/resume', { method: 'POST', body: formData });
                renderResumeAnalysis(result.resume_analysis);
            } catch (error) { 
                alert(`Analysis failed: ${error.message}`);
            } finally {
                analyzeResumeBtn.textContent = 'Analyze Scroll';
                analyzeResumeBtn.disabled = false;
            }
        });

        function renderResumeAnalysis(analysisText) {
            const analysisHTML = marked.parse(analysisText || 'No analysis available.');
            const score = (analysisText.match(/diamond/gi) || []).length * 2 + (analysisText.match(/gold/gi) || []).length;
            let tier = 'Wood';
            // FIXED: Using reliable image links
            let tierImg = 'https://static.wikia.nocookie.net/minecraft_gamepedia/images/d/d5/Wooden_Sword_JE2_BE2.png';
            if (score > 5) { tier = 'Diamond'; tierImg = 'https://static.wikia.nocookie.net/minecraft_gamepedia/images/4/44/Diamond_Sword_JE3_BE3.png'; }
            else if (score > 2) { tier = 'Gold'; tierImg = 'https://static.wikia.nocookie.net/minecraft_gamepedia/images/d/de/Golden_Sword_JE2_BE2.png'; }
            
            resumeAnalysisContainer.innerHTML = `
                <div class="flex items-center gap-4">
                    <img src="${tierImg}" alt="${tier} Sword" class="w-24 h-24">
                    <div>
                        <h3 class="text-2xl !border-0 !m-0 !p-0">Resume Quality: ${tier} Tier</h3>
                        <p>Your resume has been analyzed and enchanted.</p>
                    </div>
                </div>
                <div class="mt-4 prose max-w-none">${analysisHTML}</div>
            `;
            resumeAnalysisContainer.classList.remove('hidden');
        }

        // --- PERFORMANCE DASHBOARD ---
        async function fetchHistoryAndRenderDashboard() {
            try {
                const history = await apiFetch('/assessment/history');
                if (history && history.length > 0) {
                    renderPerformanceDashboard(history);
                } else {
                    performanceChartContainer.innerHTML = '<p class="text-center">Complete a quest to chart your journey.</p>';
                }
            } catch (e) {
                console.error("Could not fetch history", e);
                performanceChartContainer.innerHTML = '<p class="text-center text-red-500">Could not load journey data.</p>';
            }
        }

        function renderPerformanceDashboard(history) {
            const sortedHistory = history.slice().sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            const labels = sortedHistory.map(item => new Date(item.created_at).toLocaleDateString());
            const scores = sortedHistory.map(item => item.score);
            
            const maxScore = Math.max(...scores);
            // FIXED: Using a reliable image link
            const diamondIcon = `<img src="https://static.wikia.nocookie.net/minecraft_gamepedia/images/e/ea/Diamond_JE3_BE3.png" class="icon-pixel !w-8 !h-8" alt="Diamond">`;
            highestScoreEl.innerHTML = `${maxScore} ${diamondIcon}`;
            averageScoreEl.textContent = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);

            const ctx = document.getElementById('score-chart').getContext('2d');
            if (scoreChart) scoreChart.destroy();
            scoreChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'EXP Gained', data: scores,
                        borderColor: '#55FFFF', backgroundColor: 'rgba(85, 255, 255, 0.2)',
                        fill: true, tension: 0.1, pointBackgroundColor: '#55FFFF', pointRadius: 5
                    }]
                },
                options: { 
                    responsive: true, 
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.2)'}, ticks: { color: 'white'} },
                        x: { grid: { color: 'rgba(255,255,255,0.2)'}, ticks: { color: 'white'} }
                    } 
                }
            });
        }
    </script>
</body>
</html>
